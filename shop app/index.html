<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senani Mobile Shop | Advanced HR System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonBlue: '#00f3ff',
                        neonPink: '#ff00ff',
                        neonGreen: '#39ff14',
                        neonRed: '#ff3333',
                        neonOrange: '#ffaa00',
                        darkBg: '#050b14',
                        panelBg: '#0f172a'
                    },
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        rajdhani: ['Rajdhani', 'sans-serif'],
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'slide-in-down': 'slideDown 0.5s ease-out',
                        'coin-bounce': 'coinBounce 0.5s ease-out'
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px #ff00ff' },
                            '50%': { boxShadow: '0 0 20px #ff00ff' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        coinBounce: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '50%': { transform: 'scale(1.2)', opacity: '1' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050b14; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; overflow-x: hidden; }
        
        .glow-text-blue { text-shadow: 0 0 10px #00f3ff; }
        .glow-border-blue { box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); border: 1px solid #00f3ff; }
        .glow-border-pink { box-shadow: 0 0 15px rgba(255, 0, 255, 0.2); border: 1px solid #ff00ff; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .emp-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .emp-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.15);
            border-color: #00f3ff;
        }

        .hidden-section { display: none !important; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: rgba(15, 23, 42, 0.95); border-left: 4px solid #00f3ff;
            padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out forwards; backdrop-filter: blur(5px);
            color: white; min-width: 280px;
        }
        .toast.error { border-left-color: #ff00ff; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .status-active { background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid #39ff14; box-shadow: 0 0 5px rgba(57,255,20,0.3); }
        .status-inactive { background: rgba(255, 51, 51, 0.1); color: #ff3333; border: 1px solid #ff3333; box-shadow: 0 0 5px rgba(255,51,51,0.3); }
        
        .timer-font { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        
        /* Warning Box Styles */
        .limit-warning-box {
            background: rgba(255, 51, 51, 0.15);
            border: 1px solid #ff3333;
            color: #ff3333;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="toast-container"></div>

    <!-- Login Screen -->
    <section id="login-section" class="flex-grow flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-xl w-full max-w-md glow-border-blue relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-neonBlue to-transparent"></div>
            <div class="text-center mb-8">
                <!-- LOGO IN LOGIN -->
                <img src="https://z-cdn-media.chatglm.cn/files/918459ef-80d8-49f4-b462-2f83f4d62608.jpg?auth_key=1870629274-0334d5da705549618448a7446a2fbb9a-0-a60aba058f9501da0c33e0d5f0cd6143" 
                     class="h-32 w-auto mx-auto mb-4 drop-shadow-[0_0_15px_rgba(168,85,247,0.6)] rounded-lg bg-white p-1">
                
                <p class="text-gray-400 tracking-widest text-sm uppercase">Mobile Shop Management System</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-neonBlue mb-2 font-bold">Username</label>
                    <input type="text" id="login-username" class="w-full bg-darkBg border border-gray-700 rounded p-3 text-white focus:border-neonBlue focus:outline-none" placeholder="Enter username" required>
                </div>
                <div>
                    <label class="block text-neonBlue mb-2 font-bold">Password</label>
                    <input type="password" id="login-password" class="w-full bg-darkBg border border-gray-700 rounded p-3 text-white focus:border-neonBlue focus:outline-none" placeholder="Enter password" required>
                </div>
                <button type="submit" class="w-full bg-neonBlue/20 text-neonBlue border border-neonBlue py-3 rounded font-bold hover:bg-neonBlue hover:text-black transition-all font-orbitron">
                    LOGIN SYSTEM
                </button>
            </form>
            <div class="mt-4 text-center text-xs text-gray-500">
                <p class="mb-1 font-bold text-neonPink">Super Admin: xxxxxxxxxx</p>
                <p>Password: xxxxxxxxxx</p>
            </div>
        </div>
    </section>

    <!-- Dashboard -->
    <div id="dashboard-section" class="hidden-section flex-grow flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 glass-panel border-r border-gray-800 flex flex-col justify-between z-10">
            <div>
                <!-- LOGO IN SIDEBAR -->
                <div class="p-4 border-b border-gray-800 flex flex-col items-center">
                    <img src="https://z-cdn-media.chatglm.cn/files/918459ef-80d8-49f4-b462-2f83f4d62608.jpg?auth_key=1870629274-0334d5da705549618448a7446a2fbb9a-0-a60aba058f9501da0c33e0d5f0cd6143" 
                         class="h-16 w-auto mb-2">
                    <h2 class="text-xl font-orbitron font-bold text-neonBlue glow-text-blue">SENANI</h2>
                    <p class="text-xs text-gray-400" id="user-role-display">Admin Panel</p>
                </div>
                <nav class="mt-6 px-4 space-y-2" id="nav-menu"></nav>
            </div>
            <div class="p-4 border-t border-gray-800">
                <button onclick="logout()" class="flex items-center w-full text-red-400 hover:text-red-200 transition-colors p-2 rounded hover:bg-red-500/10">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow bg-darkBg p-4 md:p-8 overflow-y-auto relative">
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#00f3ff 1px, transparent 1px), linear-gradient(90deg, #00f3ff 1px, transparent 1px); background-size: 30px 30px;"></div>
            <div class="relative z-10">
                <header class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <h2 id="page-title" class="text-3xl font-orbitron text-white">Dashboard</h2>
                    <div class="text-right">
                        <p id="current-time" class="text-xl text-neonBlue font-mono">00:00:00</p>
                        <p id="current-date" class="text-sm text-gray-400">Loading...</p>
                    </div>
                </header>

                <!-- 1. ADMIN HOME -->
                <div id="view-admin-home" class="hidden-section space-y-6 animate-pop">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-panel p-6 rounded-lg glow-border-blue">
                            <h3 class="text-gray-400 text-xs uppercase tracking-widest">Total Employees</h3>
                            <p class="text-4xl font-bold text-white mt-2" id="stat-emp-count">0</p>
                        </div>
                        <div class="glass-panel p-6 rounded-lg border border-neonRed">
                            <h3 class="text-gray-400 text-xs uppercase tracking-widest">Pending Advances</h3>
                            <p class="text-4xl font-bold text-neonRed mt-2" id="stat-advances">LKR 0</p>
                        </div>
                        <div class="glass-panel p-6 rounded-lg border border-neonGreen">
                            <h3 class="text-gray-400 text-xs uppercase tracking-widest">Est. Payroll</h3>
                            <p class="text-4xl font-bold text-neonGreen mt-2" id="stat-salary-total">LKR 0</p>
                        </div>
                    </div>

                    <div class="glass-panel p-8 rounded-xl text-center border border-gray-700 hover:border-neonBlue transition-colors group cursor-pointer" onclick="showEmployeeList()">
                        <div class="w-16 h-16 bg-neonBlue/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-neonBlue group-hover:text-black transition-all text-neonBlue">
                            <i class="fas fa-users-cog text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2 group-hover:text-neonBlue transition-colors">Manage Employees</h3>
                        <p class="text-gray-400 text-sm">View profiles, edit details, or remove staff members.</p>
                        <div class="mt-4 inline-block px-6 py-2 border border-gray-600 rounded-full text-xs font-bold group-hover:border-neonBlue group-hover:bg-neonBlue group-hover:text-black transition-all">ACCESS PANEL &rarr;</div>
                    </div>

                    <div class="glass-panel p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-xl text-neonGreen font-bold"><i class="fas fa-chart-line mr-2"></i>Financial Overview</h3>
                           <button onclick="downloadAdminPDF()" class="text-xs text-neonBlue border border-neonBlue px-3 py-1 rounded hover:bg-neonBlue hover:text-black transition-colors">Download Full Report</button>
                       </div>
                       <div class="overflow-x-auto">
                           <table class="w-full text-left border-collapse">
                               <thead>
                                   <tr class="text-gray-400 border-b border-gray-700 text-xs">
                                       <th class="p-3">Employee</th>
                                       <th class="p-3">Days</th>
                                       <th class="p-3">Short Lev</th>
                                       <th class="p-3 text-neonRed">Advances</th>
                                       <th class="p-3">Net Salary</th>
                                   </tr>
                               </thead>
                               <tbody id="salary-table-body" class="text-sm"></tbody>
                           </table>
                       </div>
                   </div>
                </div>

                <!-- 2. EMPLOYEE LIST -->
                <div id="view-admin-employees" class="hidden-section space-y-6 animate-pop">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-gray-800 pb-4">
                        <div>
                            <h3 class="text-2xl text-white font-orbitron">Staff Directory</h3>
                            <p class="text-gray-400 text-sm">Manage all employee records</p>
                        </div>
                        <button onclick="toggleModal('add-employee-modal')" class="bg-neonBlue text-black px-6 py-3 rounded font-bold hover:bg-white transition-all shadow-[0_0_15px_#00f3ff]">
                            <i class="fas fa-plus mr-2"></i> Add New Employee
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="employee-cards-container"></div>
                </div>

                <!-- 3. EMPLOYEE DETAIL -->
                <div id="view-admin-employee-detail" class="hidden-section animate-pop">
                    <button onclick="showEmployeeList()" class="mb-6 text-gray-400 hover:text-white transition-colors flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Back to List
                    </button>
                    <div class="glass-panel rounded-xl overflow-hidden border border-gray-700">
                        <div class="h-32 bg-gradient-to-r from-neonBlue/20 to-neonPink/20 border-b border-gray-700 relative">
                            <div class="absolute -bottom-10 left-8">
                                <img id="detail-photo" src="" alt="Profile" class="w-24 h-24 rounded-full border-4 border-darkBg object-cover shadow-xl bg-gray-800">
                            </div>
                        </div>
                        <div class="pt-12 px-8 pb-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                                <div>
                                    <h2 id="detail-name" class="text-3xl font-bold text-white font-orbitron">Employee Name</h2>
                                    <p id="detail-role" class="text-neonBlue font-medium">Job Role</p>
                                </div>
                                <div class="mt-4 md:mt-0 flex gap-3">
                                    <button onclick="editEmployee()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm transition-colors">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </button>
                                    <button onclick="deleteCurrentEmployee()" class="px-4 py-2 bg-red-900/40 hover:bg-red-600 text-red-400 hover:text-white border border-red-500 rounded text-sm transition-colors">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-darkBg/50 p-4 rounded-lg border border-gray-800">
                                    <p class="text-gray-500 text-xs uppercase mb-1">ID</p>
                                    <p id="detail-id" class="text-white font-mono">#---</p>
                                </div>
                                <div class="bg-darkBg/50 p-4 rounded-lg border border-gray-800">
                                    <p class="text-gray-500 text-xs uppercase mb-1">Department</p>
                                    <p id="detail-dept" class="text-white">---</p>
                                </div>
                                <div class="bg-darkBg/50 p-4 rounded-lg border border-gray-800">
                                    <p class="text-gray-500 text-xs uppercase mb-1">Status</p>
                                    <span id="detail-status" class="inline-block px-2 py-1 rounded text-xs font-bold status-active">Active</span>
                                </div>
                                <div class="bg-darkBg/50 p-4 rounded-lg border border-gray-800">
                                    <p class="text-gray-500 text-xs uppercase mb-1">Total Advances (Month)</p>
                                    <p id="detail-advances" class="text-neonRed font-bold">LKR 0</p>
                                </div>
                                <div class="bg-darkBg/50 p-4 rounded-lg border border-gray-800">
                                    <p class="text-gray-500 text-xs uppercase mb-1">Net Salary</p>
                                    <p id="detail-salary" class="text-neonGreen font-bold">LKR 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. EMPLOYEE HOME -->
                <div id="view-employee-home" class="hidden-section">
                    <div class="max-w-2xl mx-auto space-y-6">
                        
                        <!-- EMPLOYEE ONLY ADVERTISEMENT -->
                        <div class="animate-slide-in-down bg-gradient-to-r from-neonOrange/20 to-neonPink/20 border border-neonOrange/50 p-6 rounded-xl flex justify-between items-center shadow-[0_0_20px_rgba(255,170,0,0.2)] relative overflow-hidden group">
                            <div class="absolute top-0 right-0 -mt-2 -mr-2 w-24 h-24 bg-neonOrange blur-[50px] opacity-20"></div>
                            <div class="relative z-10">
                                <h4 class="text-neonOrange font-bold text-xs uppercase tracking-widest mb-1"><i class="fas fa-star mr-2"></i>Staff Exclusive Offer</h4>
                                <p class="text-white text-lg font-bold leading-tight">20% OFF Phone Accessories!</p>
                                <p class="text-gray-400 text-sm mt-1">Valid until end of month. Contact Admin to claim.</p>
                            </div>
                            <div class="relative z-10 text-4xl text-neonOrange opacity-80 group-hover:scale-110 transition-transform">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <!-- END ADVERTISEMENT -->

                        <!-- MAIN CLOCK SYSTEM -->
                        <div class="glass-panel p-8 rounded-xl border-t-4 border-neonBlue relative overflow-hidden">
                            <div id="timer-glow" class="absolute top-0 left-0 w-full h-full bg-neonBlue/5 pointer-events-none transition-all duration-1000"></div>
                            <div class="relative z-10 text-center">
                                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-4">Main Shift Timer</h3>
                                <div class="bg-black border-2 border-neonBlue rounded-lg p-4 mb-6 inline-block min-w-[200px] shadow-[0_0_15px_rgba(0,243,255,0.3)]">
                                    <p id="timer-display" class="text-5xl text-neonBlue timer-font font-bold">00:00:00</p>
                                    <p id="timer-status" class="text-xs text-gray-400 mt-2">IDLE</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                                    <button id="btn-clock-in" onclick="startWork()" class="p-4 bg-green-900/30 border border-green-500 rounded hover:bg-green-500 hover:text-white transition-all group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-play text-2xl mb-2 text-green-500 group-hover:text-white"></i>
                                        <div class="font-bold text-sm">CLOCK IN</div>
                                    </button>
                                    <button id="btn-clock-out" onclick="endWork()" disabled class="p-4 bg-red-900/30 border border-red-500 rounded hover:bg-red-500 hover:text-white transition-all group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-stop text-2xl mb-2 text-red-500 group-hover:text-white"></i>
                                        <div class="font-bold text-sm">CLOCK OUT</div>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-4">Admin notified via WhatsApp on clock in/out.</p>
                            </div>
                        </div>

                        <!-- SHORT LEAVE SYSTEM (Independent) -->
                        <div class="glass-panel p-6 rounded-xl border-t-4 border-yellow-500 relative">
                            <!-- Warning Box -->
                            <div id="short-leave-warning-box" class="hidden limit-warning-box animate-pulse-glow">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span class="font-bold">Short Leave Over Limit (>10 Hrs)</span>
                            </div>

                            <h3 class="text-lg font-bold text-white mb-2">Short Leave</h3>
                            <p class="text-xs text-gray-400 mb-4">Works independently of main shift. Calculates separately.</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="btn-short-out" onclick="toggleShortLeave('OUT')" class="p-3 bg-gray-800 border border-gray-600 rounded hover:border-yellow-400 transition-all flex flex-col items-center">
                                    <i class="fas fa-walking mb-1 text-yellow-400"></i> Short Leave OUT
                                </button>
                                <button id="btn-short-in" onclick="toggleShortLeave('IN')" class="p-3 bg-gray-800 border border-gray-600 rounded hover:border-yellow-400 transition-colors opacity-50 cursor-not-allowed flex flex-col items-center" disabled>
                                    <i class="fas fa-undo mb-1 text-yellow-400"></i> Short Leave IN
                                </button>
                            </div>
                            <div class="mt-3 text-center text-yellow-400 font-mono" id="short-leave-status">Status: Active</div>
                        </div>
                        
                        <!-- ADVANCE SYSTEM WITH LIMIT -->
                        <div class="glass-panel p-6 rounded-xl border-t-4 border-neonOrange relative">
                            <h3 class="text-lg font-bold text-white mb-2">Request Advance</h3>
                            
                            <!-- Warning Box -->
                            <div id="advance-warning-box" class="hidden limit-warning-box animate-pulse-glow">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span class="font-bold">Advance Over Limit (>6000)</span>
                            </div>

                            <div class="flex justify-between items-center mb-4">
                                <div class="text-xs text-neonRed font-mono">Deducted from Salary</div>
                            </div>
                            <div class="flex gap-3 items-end">
                                <div class="flex-grow">
                                    <label class="text-xs text-gray-400 mb-1 block">Amount (LKR)</label>
                                    <input type="number" id="advance-input" class="w-full bg-darkBg border border-gray-600 rounded p-3 text-white focus:border-neonOrange outline-none text-xl font-mono" placeholder="0">
                                </div>
                                <button onclick="takeAdvance()" id="btn-advance" class="h-[58px] w-24 bg-neonOrange text-black font-bold rounded hover:bg-orange-400 transition-all shadow-[0_0_10px_#ffaa00] flex items-center justify-center">
                                    <i class="fas fa-hand-holding-usd mr-2"></i> TAKE
                                </button>
                            </div>
                            <div class="mt-4 flex flex-col gap-2 text-sm text-gray-500">
                                <span>Limit: LKR 6,000 per month.</span>
                                <span>Excess amount will be visible in Paysheet.</span>
                            </div>
                            <div id="advance-confirmation" class="mt-4 hidden">
                                <div class="p-3 bg-neonGreen/10 border border-neonGreen/30 rounded text-center animate-coin-bounce">
                                    <p class="text-neonGreen font-bold text-sm"><i class="fas fa-check-circle mr-2"></i> Advance Recorded Successfully</p>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-xl border-t-4 border-neonRed">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white">Leaves (5 Days)</h3>
                                <div class="text-xs text-gray-400" id="leave-count-display">0/5 Used</div>
                            </div>
                            <div class="flex justify-center gap-3 mb-6" id="leave-visual-container"></div>
                            <button onclick="takeFullLeave()" class="w-full py-3 bg-red-900/20 border border-red-500 text-red-400 rounded font-bold hover:bg-red-500 hover:text-white transition-all">
                                <i class="fas fa-calendar-times mr-2"></i> Take Full Leave Today
                            </button>
                        </div>

                        <div class="glass-panel p-6 rounded-lg border border-gray-700">
                            <h3 class="text-lg text-neonGreen font-bold mb-4">Estimated Monthly Salary</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Total Basic + OT</span>
                                    <span class="text-white" id="my-gross-pay">LKR 0</span>
                                </div>
                                <div class="flex justify-between text-sm text-neonOrange">
                                    <span class="text-gray-400">Short Leave Deduction</span>
                                    <span id="my-short-leave-deduction">LKR 0</span>
                                </div>
                                <div class="flex justify-between text-sm text-neonRed">
                                    <span class="text-gray-400">Advances Taken</span>
                                    <span class="text-neonRed" id="my-total-advances">LKR 0</span>
                                </div>
                                <div class="h-px bg-gray-700 my-2"></div>
                                <div class="flex justify-between text-xl font-bold">
                                    <span class="text-white">Net Salary</span>
                                    <span class="text-neonGreen" id="my-net-salary">LKR 0</span>
                                </div>
                            </div>
                            <!-- DOWNLOAD PAYSHEET BUTTON -->
                            <button onclick="downloadMyPaysheet()" class="w-full py-4 bg-neonBlue/20 border border-neonBlue text-neonBlue rounded font-bold hover:bg-neonBlue hover:text-black transition-all flex items-center justify-center group mt-4">
                                <i class="fas fa-file-invoice mr-2"></i> Download My Paysheet
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <footer class="bg-black text-gray-600 py-3 text-center text-xs border-t border-gray-900 z-20 flex justify-center items-center gap-3">
        <img src="https://z-cdn-media.chatglm.cn/files/918459ef-80d8-49f4-b462-2f83f4d62608.jpg?auth_key=1870629274-0334d5da705549618448a7446a2fbb9a-0-a60aba058f9501da0c33e0d5f0cd6143" class="h-6 w-auto opacity-80">
        <p>&copy; <span id="year"></span> Senani Mobile Shop. Created by Lakshan.</p>
    </footer>

    <!-- Add Employee Modal -->
    <div id="add-employee-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-xl glow-border-pink">
            <h3 class="text-xl text-neonPink font-bold mb-4">Add New Employee</h3>
            <form id="add-emp-form" class="space-y-3">
                <input type="text" id="new-emp-name" placeholder="Full Name" class="w-full bg-darkBg border border-gray-600 rounded p-2 text-white focus:border-neonPink outline-none" required>
                <input type="text" id="new-emp-role" placeholder="Job Role" class="w-full bg-darkBg border border-gray-600 rounded p-2 text-white focus:border-neonPink outline-none" required>
                <input type="text" id="new-emp-dept" placeholder="Department" class="w-full bg-darkBg border border-gray-600 rounded p-2 text-white focus:border-neonPink outline-none" required>
                <input type="text" id="new-emp-user" placeholder="Username" class="w-full bg-darkBg border border-gray-600 rounded p-2 text-white focus:border-neonPink outline-none" required>
                <input type="password" id="new-emp-pass" placeholder="Password" class="w-full bg-darkBg border border-gray-600 rounded p-2 text-white focus:border-neonPink outline-none" required>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="toggleModal('add-employee-modal')" class="flex-1 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-neonPink text-white rounded font-bold hover:bg-pink-600">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const DAILY_BASIC = 1250;
        const OT_RATE_PER_HR = 75;
        const ATTENDANCE_ALLOWANCE = 5000;
        const ADMIN_WHATSAPP_NUMBER = "94767546714";
        const SHOP_CLOSE_HOUR = 18;
        const ADVANCE_LIMIT = 6000;
        const SHORT_LEAVE_LIMIT_HRS = 10;

        let db = {
            employees: [
                { id: 1, name: 'Sriyantha Senanarathna', username: 'Sriyantha123', password: 'Sriyantha#1234', role: 'admin', photo: 'https://i.pravatar.cc/150?img=11', dept: 'Management', status: 'Active', joinDate: '2020-01-15', phone: '077-1234567' }
            ],
            attendance: [],
            leaves: [], // type: 'full' | 'short'
            advances: [],
            shortLeaveSession: null // { startTime, empId }
        };

        if(localStorage.getItem('senani_employees')) {
            localStorage.removeItem('senani_employees');
            localStorage.removeItem('senani_attendance');
            localStorage.removeItem('senani_leaves');
            const storedEmp = JSON.parse(localStorage.getItem('senani_employees'));
            if(storedEmp) db.employees = storedEmp;
            const storedAdvances = localStorage.getItem('senani_advances');
            if(storedAdvances) db.advances = JSON.parse(storedAdvances);
        }

        let currentUser = null;
        let currentDetailId = null;
        let timerInterval = null;
        let startTime = null;
        let isWorking = false;

        function sendWhatsAppMessageToAdmin(message) {
            const url = `https://wa.me/${ADMIN_WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        document.getElementById('year').textContent = new Date().getFullYear();
        updateTime();
        setInterval(updateTime, 1000);

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const user = db.employees.find(emp => emp.username === u && emp.password === p);
            if (user) {
                currentUser = user;
                showToast(`Welcome, ${user.name}!`, 'success');
                initDashboard();
            } else {
                showToast('Invalid credentials.', 'error');
            }
        });

        function logout() {
            if (isWorking) {
                if(!confirm("You are currently clocked in. Are you sure you want to log out?")) return;
                stopTimer();
                isWorking = false;
            }
            currentUser = null;
            db.shortLeaveSession = null;
            document.getElementById('dashboard-section').classList.add('hidden-section');
            document.getElementById('login-section').classList.remove('hidden-section');
        }

        function initDashboard() {
            document.getElementById('login-section').classList.add('hidden-section');
            document.getElementById('dashboard-section').classList.remove('hidden-section');
            document.getElementById('user-role-display').innerText = currentUser.role === 'admin' ? 'Admin Panel' : 'Employee Portal';

            if (currentUser.role === 'admin') {
                setupAdminNav();
                showAdminHome();
            } else {
                setupEmployeeNav();
                showEmployeeHome();
            }
        }

        function hideAllViews() {
            document.getElementById('view-admin-home').classList.add('hidden-section');
            document.getElementById('view-admin-employees').classList.add('hidden-section');
            document.getElementById('view-admin-employee-detail').classList.add('hidden-section');
            document.getElementById('view-employee-home').classList.add('hidden-section');
        }

        function setupAdminNav() {
            document.getElementById('nav-menu').innerHTML = `
                <button onclick="showAdminHome()" class="w-full text-left p-3 rounded hover:bg-neonBlue/20 hover:text-neonBlue transition-colors text-gray-300"><i class="fas fa-home mr-3"></i> Dashboard</button>
                <button onclick="showEmployeeList()" class="w-full text-left p-3 rounded hover:bg-neonBlue/20 hover:text-neonBlue transition-colors text-gray-300"><i class="fas fa-users mr-3"></i> Employees</button>
            `;
        }

        function showAdminHome() {
            hideAllViews();
            document.getElementById('view-admin-home').classList.remove('hidden-section');
            document.getElementById('page-title').innerText = "Admin Dashboard";
            renderAdminStats();
            renderSalaryTable();
        }

        function showEmployeeList() {
            hideAllViews();
            document.getElementById('view-admin-employees').classList.remove('hidden-section');
            document.getElementById('page-title').innerText = "Staff Directory";
            renderEmployeeCards();
        }

        function renderEmployeeCards() {
            const container = document.getElementById('employee-cards-container');
            container.innerHTML = '';
            db.employees.forEach(emp => {
                const statusClass = emp.status === 'Active' ? 'status-active' : 'status-inactive';
                const roleBadge = emp.role === 'admin' ? 'bg-neonPink/20 text-neonPink border border-neonPink' : 'bg-neonBlue/20 text-neonBlue border border-neonBlue';
                const card = document.createElement('div');
                card.className = "emp-card glass-panel p-4 rounded-lg relative overflow-hidden cursor-pointer group";
                card.onclick = () => openEmployeeDetail(emp.id);
                card.innerHTML = `
                    <div class="absolute top-2 right-2">
                        <span class="text-xs px-2 py-1 rounded ${statusClass}">${emp.status}</span>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${emp.photo}" class="w-16 h-16 rounded-full border-2 border-gray-700 group-hover:border-neonBlue transition-colors">
                        <div>
                            <h4 class="text-white font-bold text-lg leading-tight group-hover:text-neonBlue transition-colors">${emp.name}</h4>
                            <span class="text-xs px-2 py-0.5 rounded mt-1 inline-block ${roleBadge}">${emp.role}</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-400">
                        <div class="flex items-center"><i class="fas fa-briefcase w-6 text-center text-gray-600"></i> ${emp.dept || 'General'}</div>
                        <div class="flex items-center"><i class="fas fa-id-card w-6 text-center text-gray-600"></i> ID: #${emp.id}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openEmployeeDetail(id) {
            const emp = db.employees.find(e => e.id === id);
            if(!emp) return;
            currentDetailId = id;
            hideAllViews();
            document.getElementById('view-admin-employee-detail').classList.remove('hidden-section');
            document.getElementById('page-title').innerText = "Employee Profile";
            document.getElementById('detail-photo').src = emp.photo;
            document.getElementById('detail-name').innerText = emp.name;
            document.getElementById('detail-role').innerText = emp.role.toUpperCase();
            document.getElementById('detail-id').innerText = `#${emp.id}`;
            document.getElementById('detail-dept').innerText = emp.dept || 'N/A';
            document.getElementById('detail-status').innerText = emp.status;
            document.getElementById('detail-status').className = `inline-block px-2 py-1 rounded text-xs font-bold ${emp.status === 'Active' ? 'status-active' : 'status-inactive'}`;
            
            const data = calculateNetSalary(emp.id);
            document.getElementById('detail-salary').innerText = `LKR ${data.net.toLocaleString()}`;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const leaves = db.leaves.filter(l => l.empId === emp.id && l.date.startsWith(currentMonth) && l.type === 'full').length;
            document.getElementById('detail-advances').innerText = `LKR ${data.totalAdvances.toLocaleString()}`;
        }

        function deleteCurrentEmployee() {
            if (!currentDetailId) return;
            if (currentDetailId === currentUser.id) {
                showToast("You cannot delete your own account.", "error");
                return;
            }
            if (confirm(`Remove ${currentDetailId}?`)) {
                db.employees = db.employees.filter(e => e.id !== currentDetailId);
                saveData();
                showToast('Removed', 'success');
                showEmployeeList();
            }
        }

        function editEmployee() { showToast("Edit: Coming soon", "success"); }

        function takeAdvance() {
            const input = document.getElementById('advance-input');
            const amount = parseFloat(input.value);
            const btn = document.getElementById('btn-advance');
            const confirmBox = document.getElementById('advance-confirmation');
            const warningBox = document.getElementById('advance-warning-box');

            if (!amount || amount <= 0) {
                showToast("Please enter a valid amount.", "error");
                return;
            }

            db.advances.push({
                id: Date.now(),
                empId: currentUser.id,
                amount: amount,
                date: new Date().toISOString().split('T')[0]
            });
            saveData();

            btn.classList.add('scale-90', 'opacity-50');
            setTimeout(() => btn.classList.remove('scale-90', 'opacity-50'), 200);
            
            confirmBox.classList.remove('hidden');
            setTimeout(() => confirmBox.classList.add('hidden'), 3000);
            
            input.value = '';
            renderEarningsSummary();
            showToast(`Advance of LKR ${amount} taken.`, "success");
        }

        function startWork() {
            if (isWorking) return;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            const todayStr = now.toISOString().split('T')[0];
            const existing = db.attendance.find(a => a.empId === currentUser.id && a.date === todayStr);
            if (existing && !existing.outTime) {
                showToast("Already clocked in!", "error");
                return;
            }

            isWorking = true;
            startTime = now;
            
            db.attendance.push({
                id: Date.now(),
                empId: currentUser.id,
                date: todayStr,
                inTime: timeStr,
                outTime: null,
                duration: 0,
                otHours: 0,
                totalPay: 0
            });

            saveData();
            document.getElementById('btn-clock-in').disabled = true;
            document.getElementById('btn-clock-out').disabled = false;
            document.getElementById('timer-glow').classList.add('bg-neonBlue/10');
            document.getElementById('timer-status').innerText = "WORKING";
            document.getElementById('timer-status').className = "text-xs text-neonGreen mt-2 font-bold animate-pulse";
            
            sendWhatsAppMessageToAdmin(`游닉 SENANI SHOP UPDATE\n\nEmployee: ${currentUser.name}\nAction: CLOCKED IN\nTime: ${timeStr}`);
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function endWork() {
            if (!isWorking) return;
            clearInterval(timerInterval);
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            const todayStr = now.toISOString().split('T')[0];
            const record = db.attendance.find(a => a.empId === currentUser.id && a.date === todayStr);
            if (!record) return;

            const durationMs = now - startTime;
            const totalSeconds = Math.floor(durationMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            const closeTime = new Date(now);
            closeTime.setHours(18, 0, 0, 0);
            const otDurationMs = (now > closeTime) ? (now - closeTime) : 0;
            const otHrs = Math.max(0, otDurationMs / (1000 * 60 * 60));

            const basicPay = DAILY_BASIC; 
            const otPay = otHrs * OT_RATE_PER_HR;
            const dailyTotal = basicPay + otPay;

            record.outTime = timeStr;
            record.duration = totalSeconds;
            record.otHours = otHrs;
            record.totalPay = dailyTotal;

            isWorking = false;
            saveData();

            document.getElementById('btn-clock-in').disabled = false;
            document.getElementById('btn-clock-out').disabled = true;
            document.getElementById('timer-glow').classList.remove('bg-neonBlue/10');
            document.getElementById('timer-status').innerText = "FINISHED";
            document.getElementById('timer-status').className = "text-xs text-gray-500 mt-2";

            showToast(`Daily Salary: LKR ${dailyTotal.toFixed(2)} (OT: ${otHrs.toFixed(2)} hrs)`, "success");
            sendWhatsAppMessageToAdmin(`游닉 SENANI SHOP UPDATE\n\nEmployee: ${currentUser.name}\nAction: CLOCKED OUT\nTime: ${timeStr}\nDuration: ${hours}h ${minutes}m\nDaily Pay: ${dailyTotal.toFixed(2)}`);
            
            renderEarningsSummary();
        }

        function updateTimerDisplay() {
            if (!startTime) return;
            const now = new Date();
            const diffMs = now - startTime;
            const totalSeconds = Math.floor(diffMs / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(Math.floor(totalSeconds % 60)).padStart(2, '0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer-display').innerText = "00:00:00";
            isWorking = false;
        }

        // --- SHORT LEAVE SYSTEM (Independent) ---
        function toggleShortLeave(action) {
            if (action === 'OUT') {
                if (db.shortLeaveSession) { showToast("Already on short leave!", "error"); return; }
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
                
                db.shortLeaveSession = { startTime: now, empId: currentUser.id };
                updateShortLeaveUI();
                const msg = `游닉 SENANI SHOP UPDATE\n\nEmployee: ${currentUser.name}\nAction: SHORT LEAVE START\nTime: ${timeStr}`;
                sendWhatsAppMessageToAdmin(msg);
                showToast("Short Leave Started.", "success");
            } else if (action === 'IN') {
                if (!db.shortLeaveSession) { showToast("No active session", "error"); return; }
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
                
                const diffMs = now - db.shortLeaveSession.startTime;
                const diffHrs = diffMs / (1000 * 60 * 60);
                const durationSecs = Math.floor(diffMs / 1000); // Store precise seconds for logic
                
                const todayStr = new Date().toISOString().split('T')[0];
                db.leaves.push({
                    id: Date.now(), empId: currentUser.id, date: todayStr, type: 'short',
                    duration: diffHrs, 
                    startTime: db.shortLeaveSession.startTime.toLocaleTimeString(), 
                    endTime: now.toLocaleTimeString()
                });
                db.shortLeaveSession = null;
                saveData();
                
                // --- LIMIT CHECK ---
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthlyShortLeaves = db.leaves.filter(l => l.empId === currentUser.id && l.date.startsWith(currentMonth) && l.type === 'short');
                const totalHrs = monthlyShortLeaves.reduce((sum, l) => sum + l.duration, 0);
                
                const warningBox = document.getElementById('short-leave-warning-box');
                if(totalHrs > SHORT_LEAVE_LIMIT_HRS) {
                    warningBox.classList.remove('hidden');
                } else {
                    warningBox.classList.add('hidden');
                }

                updateShortLeaveUI();
                renderEarningsSummary();
                
                const msg = `游닉 SENANI SHOP UPDATE\n\nEmployee: ${currentUser.name}\nAction: SHORT LEAVE RETURN\nTime: ${timeStr}\nDuration: ${diffHrs.toFixed(2)} hrs`;
                sendWhatsAppMessageToAdmin(msg);
                showToast(`Short Leave Ended.`, "success");
            }
        }

        function updateShortLeaveUI() {
            const btnOut = document.getElementById('btn-short-out');
            const btnIn = document.getElementById('btn-short-in');
            const status = document.getElementById('short-leave-status');

            if (db.shortLeaveSession) {
                btnOut.disabled = true;
                btnOut.classList.add('opacity-50', 'cursor-not-allowed');
                btnIn.disabled = false;
                btnIn.classList.remove('opacity-50', 'cursor-not-allowed');
                btnIn.classList.add('animate-pulse-glow');
                status.innerText = "Status: OUT (Time running...)";
                status.className = "mt-3 text-center text-neonRed font-mono";
            } else {
                btnOut.disabled = false;
                btnOut.classList.remove('opacity-50', 'cursor-not-allowed');
                btnIn.disabled = true;
                btnIn.classList.add('opacity-50', 'cursor-not-allowed');
                btnIn.classList.remove('animate-pulse-glow');
                status.innerText = "Status: Active (Working)";
                status.className = "mt-3 text-center text-neonGreen font-mono";
            }
        }

        function takeFullLeave() {
            const todayStr = new Date().toISOString().split('T')[0];
            const existing = db.leaves.find(l => l.empId === currentUser.id && l.date === todayStr && l.type === 'full');
            if (existing) { showToast("Already took leave", "error"); return; }
            
            db.leaves.push({ id: Date.now(), empId: currentUser.id, date: todayStr, type: 'full', duration: 0 });
            saveData();
            renderLeaveChart();
            renderEarningsSummary();
            showToast("Leave Recorded", "success");
        }

        function renderLeaveChart() {
            const container = document.getElementById('leave-visual-container');
            container.innerHTML = '';
            const currentMonth = new Date().toISOString().slice(0, 7);
            const used = db.leaves.filter(l => l.empId === currentUser.id && l.date.startsWith(currentMonth) && l.type === 'full').length;
            document.getElementById('leave-count-display').innerText = `${used}/5 Used`;

            for (let i = 0; i < 5; i++) {
                const circle = document.createElement('div');
                circle.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold leave-circle transition-all duration-300`;
                if (i < used) {
                    circle.classList.add('bg-neonRed', 'text-black', 'shadow-[0_0_10px_#ff3333]');
                    circle.innerText = i + 1;
                } else {
                    circle.classList.add('border-2', 'border-neonGreen', 'text-neonGreen');
                    circle.innerText = i + 1;
                }
                container.appendChild(circle);
            }
        }

        function renderEarningsSummary() {
            const data = calculateNetSalary(currentUser.id);
            const gross = data.basic + data.otPay;
            
            document.getElementById('my-gross-pay').innerText = `LKR ${gross.toLocaleString()}`;
            document.getElementById('my-short-leave-deduction').innerText = `LKR ${data.shortLeaveDeduction.toLocaleString()}`;
            document.getElementById('my-total-advances').innerText = `LKR ${data.totalAdvances.toLocaleString()}`;
            document.getElementById('my-net-salary').innerText = `LKR ${data.net.toLocaleString()}`;
            
            // Check Advance Limit for UI
            const advWarningBox = document.getElementById('advance-warning-box');
            if(data.totalAdvances > ADVANCE_LIMIT) {
                advWarningBox.classList.remove('hidden');
            } else {
                advWarningBox.classList.add('hidden');
            }
        }

        function calculateNetSalary(empId) {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            // 1. Attendance (Basic + OT)
            const logs = db.attendance.filter(a => a.empId === empId && a.date.startsWith(currentMonth));
            const daysWorked = logs.length;
            const basicPay = daysWorked * DAILY_BASIC;
            
            const fullLeaves = db.leaves.filter(l => l.empId === empId && l.date.startsWith(currentMonth) && l.type === 'full');
            const fullLeavesCount = fullLeaves.length;
            const excessLeaves = fullLeavesCount > 5 ? (fullLeavesCount - 5) : 0;
            let basicDeduction = excessLeaves * DAILY_BASIC;
            let allowanceDeduction = fullLeavesCount > 5 ? ATTENDANCE_ALLOWANCE : 0;

            // 2. Short Leave (New Logic: Deducted separately)
            // Assuming Short Leave reduces pay at rate of Basic/8 (Daily wage / 8 hrs)
            const shortLeaves = db.leaves.filter(l => l.empId === empId && l.date.startsWith(currentMonth) && l.type === 'short');
            const totalShortLeaveHrs = shortLeaves.reduce((sum, l) => sum + l.duration, 0);
            const shortLeaveDeduction = totalShortLeaveHrs * (DAILY_BASIC / 8); // ~156.25 LKR/hr

            // 3. Advances
            const empAdvances = db.advances.filter(a => a.empId === empId && a.date.startsWith(currentMonth));
            const totalAdvances = empAdvances.reduce((sum, a) => sum + a.amount, 0);

            // 4. Overtime Pay
            let totalOtPay = 0;
            let totalOtHrs = 0;
            logs.forEach(log => {
                totalOtHrs += (log.otHours || 0);
                totalOtPay += (log.otHours * OT_RATE_PER_HR);
            });

            const grossPay = basicPay + totalOtPay;
            const netSalary = grossPay - basicDeduction - allowanceDeduction - totalAdvances - shortLeaveDeduction; 

            return { 
                daysWorked, 
                otHours: totalOtHrs, 
                shortLeaveHrs: totalShortLeaveHrs,
                shortLeaveDeduction: shortLeaveDeduction,
                basic: basicPay, 
                otPay: totalOtPay, 
                totalAdvances: totalAdvances, 
                totalDeductions: basicDeduction + allowanceDeduction + totalAdvances + shortLeaveDeduction,
                net: netSalary 
            };
        }

        function renderAdminStats() {
            document.getElementById('stat-emp-count').innerText = db.employees.length;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const totalAdvances = db.advances.filter(a => a.date.startsWith(currentMonth)).reduce((sum, a) => sum + a.amount, 0);
            const totalShortLeaveHrs = db.leaves.filter(a => a.date.startsWith(currentMonth) && a.type === 'short').reduce((sum, l) => sum + l.duration, 0);
            
            document.getElementById('stat-advances').innerText = `LKR ${totalAdvances.toLocaleString()}`;
            let totalPayroll = 0;
            db.employees.forEach(e => totalPayroll += calculateNetSalary(e.id).net);
            document.getElementById('stat-salary-total').innerText = `LKR ${totalPayroll.toLocaleString()}`;
        }

        function renderSalaryTable() {
            const tbody = document.getElementById('salary-table-body');
            tbody.innerHTML = '';
            db.employees.forEach(emp => {
                if(emp.role === 'admin') return; 
                const data = calculateNetSalary(emp.id);
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-800 hover:bg-white/5";
                tr.innerHTML = `
                    <td class="p-3">${emp.name}</td>
                    <td class="p-3">${data.daysWorked}</td>
                    <td class="p-3 text-yellow-400">${data.shortLeaveHrs.toFixed(1)}</td>
                    <td class="p-3 text-neonRed">${data.totalAdvances > 0 ? data.totalAdvances.toLocaleString() : '-'}</td>
                    <td class="p-3 text-neonGreen">${data.net.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('add-emp-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('new-emp-name').value;
            const roleVal = document.getElementById('new-emp-role').value;
            const deptVal = document.getElementById('new-emp-dept').value;
            const user = document.getElementById('new-emp-user').value;
            const pass = document.getElementById('new-emp-pass').value;

            if (db.employees.find(e => e.username === user)) {
                showToast('Username exists!', 'error');
                return;
            }

            const newId = db.employees.length > 0 ? Math.max(...db.employees.map(e => e.id)) + 1 : 1;
            db.employees.push({
                id: newId, name: name, username: user, password: pass, role: 'employee',
                photo: `https://i.pravatar.cc/150?img=${newId}`, dept: deptVal, status: 'Active',
                joinDate: new Date().toISOString().split('T')[0], phone: 'N/A'
            });

            saveData();
            toggleModal('add-employee-modal');
            showToast('Employee added', 'success');
            showEmployeeList();
            e.target.reset();
        });

        function setupEmployeeNav() {
            document.getElementById('nav-menu').innerHTML = `<button onclick="showEmployeeHome()" class="w-full text-left p-3 rounded hover:bg-neonBlue/20 hover:text-neonBlue transition-colors text-gray-300"><i class="fas fa-user-clock mr-3"></i> My Portal</button>`;
        }

        function showEmployeeHome() {
            hideAllViews();
            document.getElementById('view-employee-home').classList.remove('hidden-section');
            document.getElementById('page-title').innerText = `Welcome, ${currentUser.name}`;
            
            // Check Short Leave Limit for UI warning
            const currentMonth = new Date().toISOString().slice(0, 7);
            const totalShortHrs = db.leaves.filter(l => l.empId === currentUser.id && l.date.startsWith(currentMonth) && l.type === 'short').reduce((sum, l) => sum + l.duration, 0);
            const slWarning = document.getElementById('short-leave-warning-box');
            if (totalShortHrs > SHORT_LEAVE_LIMIT_HRS) {
                slWarning.classList.remove('hidden');
            } else {
                slWarning.classList.add('hidden');
            }
            
            // Check Advance Limit for UI warning
            const totalAdvances = db.advances.filter(a => a.empId === currentUser.id && a.date.startsWith(currentMonth)).reduce((sum, a) => sum + a.amount, 0);
            const advWarning = document.getElementById('advance-warning-box');
            if (totalAdvances > ADVANCE_LIMIT) {
                advWarning.classList.remove('hidden');
            } else {
                advWarning.classList.add('hidden');
            }

            renderLeaveChart();
            renderEarningsSummary();
            
            const todayStr = new Date().toISOString().split('T')[0];
            const record = db.attendance.find(a => a.empId === currentUser.id && a.date === todayStr);
            
            if (record && !record.outTime) {
                startTime = new Date(`${record.date}T${record.inTime}`);
                isWorking = true;
                document.getElementById('btn-clock-in').disabled = true;
                document.getElementById('btn-clock-out').disabled = false;
                document.getElementById('timer-glow').classList.add('bg-neonBlue/10');
                document.getElementById('timer-status').innerText = "WORKING (Resumed)";
                document.getElementById('timer-status').className = "text-xs text-neonGreen mt-2 font-bold animate-pulse";
                timerInterval = setInterval(updateTimerDisplay, 1000);
            } else {
                stopTimer();
            }
        }

        // --- PDF PAYSHEET GENERATOR ---
        function downloadMyPaysheet() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = calculateNetSalary(currentUser.id);
            const currentMonth = new Date().toISOString().slice(0, 7);

            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.setTextColor(0, 243, 255);
            doc.text("PAYSLIP", 105, 20, "center");

            doc.setFontSize(12);
            doc.setTextColor(0, 255, 255);
            doc.text("Senani Mobile Shop", 105, 28, "center");
            doc.setFontSize(10);
            doc.text("No. 123, Main Street, Colombo", 105, 34, "center");

            // Details Box
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, 45, 170, 60, 'S');
            doc.setDrawColor(0);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.text(`Employee Name: ${currentUser.name}`, 30, 55);
            doc.text(`ID: #${currentUser.id}`, 130, 55);
            doc.text(`Month: ${currentMonth}`, 30, 65);
            doc.text(`Department: ${currentUser.dept || 'General'}`, 30, 75);

            // Table Data
            const tableData = [
                ['Basic Salary', `${data.daysWorked} Days @ LKR 1250`, `LKR ${data.basic.toFixed(2)}`],
                ['Overtime Pay', `${data.otHours.toFixed(2)} Hrs @ LKR 75`, `LKR ${data.otPay.toFixed(2)}`],
                ['Short Leave Deduction', `${data.shortLeaveHrs.toFixed(2)} Hrs`, `LKR -${data.shortLeaveDeduction.toFixed(2)}`],
                ['', '', ''], 
                ['Gross Pay', '', `LKR ${(data.basic + data.otPay).toFixed(2)}`],
                ['Less: Advances Taken', '', `LKR -${data.totalAdvances.toFixed(2)}`],
                ['Less: Attendance Allowance', 'If Applicable', 'LKR 0.00'],
                ['Net Pay', 'PAYABLE', `LKR ${data.net.toFixed(2)}`]
            ];

            // Render Table
            doc.autoTable({
                startY: 135,
                head: [['Description', 'Rate / Count', 'Amount (LKR)']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 4, font: 'helvetica' },
                headStyles: { fillColor: [0, 243, 255], textColor: 0, halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 70, fontStyle: 'bold', halign: 'left' },
                    1: { cellWidth: 60, halign: 'center' },
                    2: { cellWidth: 60, halign: 'right' }
                },
                didDrawPage: function (data) {
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Total Advances: LKR ${data.table.body[5][2]}`, 30, doc.lastAutoTable.finalY + 10);
                }
            });

            // LIMIT WARNINGS IN PDF
            const finalY = doc.lastAutoTable.finalY + 20;
            let yPosition = finalY;

            // Advance Limit Check
            if(data.totalAdvances > ADVANCE_LIMIT) {
                doc.setTextColor(255, 51, 51);
                doc.text("WARNING: ADVANCE LIMIT EXCEEDED (Max 6000)", 20, yPosition);
                yPosition += 10;
            }

            // Short Leave Limit Check
            if(data.shortLeaveHrs > SHORT_LEAVE_LIMIT_HRS) {
                doc.setTextColor(255, 51, 51);
                doc.text("WARNING: SHORT LEAVE LIMIT EXCEEDED (Max 10 Hrs)", 20, yPosition);
                yPosition += 10;
            }

            doc.line(20, yPosition, 170, 0);
            
            doc.setFont("helvetica", "bold");
            doc.text("Important Notes:", 20, yPosition + 10);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text("1. This is a computer-generated paysheet.", 20, yPosition + 20);
            doc.text("2. Short Leave and Advances are deducted from Net Pay.", 20, yPosition + 26);
            doc.text("3. Please verify your salary amount with Accounts Department.", 20, yPosition + 32);

            doc.setFont("helvetica", "bold");
            doc.text("_________________________", 20, yPosition + 50);
            doc.setFont("helvetica", "normal");
            doc.text("Employee Signature", 20, yPosition + 60);

            doc.setFont("helvetica", "bold");
            doc.text("_________________________", 110, yPosition + 50);
            doc.setFont("helvetica", "normal");
            doc.text("Authorized Signature", 110, yPosition + 60);

            doc.save(`Paysheet_${currentUser.name}_${currentMonth}.pdf`);
            showToast("Paysheet Downloaded!", "success");
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('current-date').innerText = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            let icon = type === 'error' ? '<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>' : '<i class="fas fa-check-circle text-neonGreen mr-2"></i>';
            toast.innerHTML = `${icon}<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        function saveData() {
            localStorage.setItem('senani_employees', JSON.stringify(db.employees));
            localStorage.setItem('senani_attendance', JSON.stringify(db.attendance));
            localStorage.setItem('senani_leaves', JSON.stringify(db.leaves));
            localStorage.setItem('senani_advances', JSON.stringify(db.advances));
        }
        function downloadAdminPDF() {
            showToast("Downloading PDF Report...", "success");
            setTimeout(() => showToast("Download complete (Simulation)", "success"), 1500);
        }
    </script>
</body>
</html>
